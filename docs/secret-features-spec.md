# ひみつの機能 仕様書

---

# ⚠️⚠️⚠️ この仕様は保留中です ⚠️⚠️⚠️

## メール送信方式は採用しません

セキュリティ上の懸念（管理者がデータを閲覧可能、誤送信リスク等）のため、
この仕様書の「大切な人への手紙（メール送信方式）」は**保留**となりました。

**新しい仕様**: [letter-sharing-spec.md](./letter-sharing-spec.md) を参照してください。

---
---

## 概要

「ひみつの機能」は設定画面の一番下に配置される、発見する楽しみのある隠し機能群です。

---

## 1. 未来への手紙（実装済み）

### コンセプト
未来の自分に手紙を書いて、指定した日に届けるタイムカプセル機能。

### 特徴
- 宛先: 自分自身
- トリガー: 指定した日時
- 届け方: アプリ内通知 + ホーム画面に表示

---

## 2. 大切な人への手紙（新規）

### コンセプト
大切な人に、自分が一定期間アプリを開かなくなったときにメッセージを届ける機能。
「デジタルレガシー」「エンディングノート」的な位置づけ。

### ターゲットユースケース
- 万が一の時に家族へメッセージを届けたい
- 感謝の気持ちを伝えそびれた時のための保険
- 自分の想いを残しておきたい

---

## 機能仕様

### 基本情報

| 項目 | 内容 |
|------|------|
| 機能名 | 大切な人への手紙 |
| 配置場所 | 設定 > ひみつの機能 |
| App Store表現 | 「いつか届けたい想いを、大切な人に届けます」 |

### 送信条件

| 設定項目 | 選択肢 |
|---------|-------|
| 非アクティブ期間 | 7日 / 14日 / 30日 |
| 確認猶予時間 | 24時間 / 48時間 / 72時間 |

### コンテンツ

| 項目 | 仕様 |
|------|------|
| 宛先 | 最大5名（メールアドレス） |
| 本文 | テキスト（無制限） |
| 写真 | 最大5枚 |
| 動画 | v1では非対応（リンク貼り付けは可） |

---

## 安全対策（多重安全装置）

### レベル0: 本人確認（前提条件）

| 対策 | 詳細 |
|------|------|
| **メール認証必須** | Firebase Auth でメールアドレス認証済みユーザーのみ利用可能 |
| **未認証の場合** | 「この機能を使うにはメール認証が必要です」と表示 |

### レベル1: 段階的な通知

```
Day 1-N:   通常（何もしない）
Day N:     ⚠️ プッシュ通知「まもなく送信されます」
Day N+3:   📧 確認メール送信（本人宛）
Day N+3+猶予: ⏰ 最終確認通知
猶予終了後:  📮 本メール送信（応答なしの場合）
```

### レベル2: キャンセル方法

| 方法 | 詳細 |
|------|------|
| アプリを開く | 自動でカウンターリセット |
| メール内リンク | ワンタップでキャンセル |
| 別デバイスからログイン | Webでもリセット可能 |

### レベル3: 送信後の取消

- 送信後30分以内なら取消可能
- 宛先に「取消のお知らせ」メールが届く

### オプション: 宛先への事前通知

| 設定 | 説明 |
|------|------|
| **通知しない**（デフォルト） | 相手に事前通知なし |
| **通知する** | 「あなた宛に手紙が設定されました」と相手に届く |

```
┌─────────────────────────────────┐
│ 宛先への事前通知                 │
├─────────────────────────────────┤
│ ○ 通知しない                    │
│ ● 通知する                       │
│   → 相手に「手紙が設定されまし   │
│     た」と事前に届きます         │
└─────────────────────────────────┘
```

### スパム・悪用対策

| 対策 | 詳細 |
|------|------|
| **レート制限** | 1アカウントあたり最大5通まで |
| **通報機能** | 受信者がメール内から通報可能 |
| **受信拒否** | 受信者がブロックできる |
| **アカウント停止** | 通報3回以上で機能制限 |

### メール到達率向上

| 対策 | 詳細 |
|------|------|
| **SPF/DKIM/DMARC** | Resendが自動設定 |
| **事前通知推奨** | スパムフィルタ回避のため事前通知を推奨 |
| **UIで案内表示** | 「相手に事前に伝えておくと確実に届きます」 |

---

## 技術構成

### バックエンド（完全無料構成）

| コンポーネント | サービス | 無料枠 |
|--------------|---------|-------|
| サーバーレス | Firebase Cloud Functions | 月125K呼び出し |
| データベース | Firestore | 1GB / 50K読取/日 |
| ストレージ | Firebase Storage | 5GB |
| メール送信 | Resend | 3,000通/月 |
| 認証 | Firebase Auth | 無制限 |

### データ構造

```typescript
interface ImportantLetter {
  id: string;
  userId: string;
  recipients: Recipient[];
  content: string;
  photoUrls: string[];
  inactiveDays: 7 | 14 | 30;
  confirmationHours: 24 | 48 | 72;
  status: 'active' | 'pending_confirmation' | 'sent' | 'cancelled';
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

interface Recipient {
  email: string;
  name: string;
}

interface UserActivity {
  userId: string;
  lastActiveAt: Timestamp;
}
```

### 処理フロー

```
1. ユーザーが手紙を作成 → Firestoreに保存
2. アプリ起動時 → lastActiveAt を更新
3. Cloud Functions（毎日実行）:
   - 全ユーザーの lastActiveAt をチェック
   - 条件を満たすユーザーに確認メール送信
   - 猶予期間経過後、本メール送信
4. ユーザーがアプリを開く or キャンセルリンク
   → status を更新、カウンターリセット
```

---

## UI設計

### 手紙作成画面

```
┌─────────────────────────────────┐
│ 大切な人への手紙               ✕ │
├─────────────────────────────────┤
│                                 │
│ 宛先（最大5名）                  │
│ ┌─────────────────────────────┐ │
│ │ tanaka@example.com     [✕] │ │
│ │ suzuki@example.com     [✕] │ │
│ │      [ + 追加 ]            │ │
│ └─────────────────────────────┘ │
│                                 │
│ メッセージ                       │
│ ┌─────────────────────────────┐ │
│ │                             │ │
│ │  大切なあなたへ...           │ │
│ │                             │ │
│ └─────────────────────────────┘ │
│                                 │
│ 📸 写真を追加（最大5枚）         │
│ [＋] [img] [img]                │
│                                 │
│ 送信条件                        │
│ [ 14日 ▼ ] アプリを開かなかったら │
│                                 │
│ 確認の猶予時間                   │
│ [ 48時間 ▼ ]                    │
│                                 │
│ ⚠️ 送信前に確認メールが届きます   │
│                                 │
│        [ 保存する ]              │
└─────────────────────────────────┘
```

### 確認メール

```
件名: ⚠️ 大切な人への手紙が48時間後に送信されます

──────────────────────────────────

〇〇さん

lifelogアプリを14日間開いていないため、
「大切な人への手紙」が48時間後に送信される予定です。

■ 送信を止める場合
[送信をキャンセル]

■ 送信を延期する場合
lifelogアプリを開いてください。

48時間以内に対応がない場合、
設定した宛先にメッセージが送信されます。

──────────────────────────────────
```

### 本メール

```
件名: 〇〇さんから大切なメッセージが届いています

──────────────────────────────────

〇〇さんへ

このメールは、△△さんがあなたに届けたいと
思っていた大切なメッセージです。

---

[手紙の本文]

---

[添付写真があれば表示]

---

このメッセージは lifelog アプリを通じて
お届けしています。

──────────────────────────────────
```

---

## App Store 審査対策

### 類似アプリの承認実績

| アプリ名 | 機能 |
|---------|------|
| Exit Life Ready: Final Wishes | 終活計画、メッセージ |
| Deathwishes | 最後の願いを共有 |
| DGLegacy | 非アクティブ検知で通知 |

※ Apple自身も「Digital Legacy」機能を提供

### 表現の注意点

| NG | OK |
|----|-----|
| 遺書 | 大切な人への手紙 |
| 死後に送る | いつか届けたい想い |
| 死んだら | 長期間アプリを開かなかったら |

---

## 今後の拡張案

### v2以降で検討

1. **動画サポート** - 短い動画（30秒）の添付
2. **音声メッセージ** - 録音機能
3. **緊急連絡先** - 送信前に第三者にも通知
4. **WebダッシュボードApp** - PCからも管理可能

---

## 関連機能アイデア

### タイムトラベル日記
- 「1年前の今日」を振り返る機能
- 既存データを活用するため実装が簡単

### 達成バッジ（隠し実績）
- 特定条件で解除されるバッジ
- ゲーミフィケーション要素

---

## 参考リンク

- [Apple Digital Legacy](https://support.apple.com/ja-jp/HT212360)
- [DGLegacy App](https://apps.apple.com/app/dglegacy/id1527aborting)
- [Firebase Cloud Functions](https://firebase.google.com/docs/functions)
- [Resend Email API](https://resend.com/)

---

## 🚀 実装ガイド（初学者向け）

この機能を実装するために必要な作業を、わかりやすくステップごとに説明します。

### 前提知識

| 用語 | 説明 |
|------|------|
| **Firebase** | Googleが提供するアプリ開発の裏側セット。データベース、認証、サーバー処理などをまとめて提供 |
| **Firestore** | Firebase内のデータベース。JSONっぽい形式でデータを保存できる |
| **Cloud Functions** | サーバーを持たずに、決まった時間やイベントで処理を実行できる仕組み |
| **Resend** | メール送信サービス。APIを呼ぶだけでメールが送れる |

---

## 📋 タスク分解

### Phase 1: 準備作業（ユーザー作業）

これらはブラウザで行う設定作業です。コードは書きません。

#### 1.1 Firebaseプロジェクト作成
- [ ] [Firebase Console](https://console.firebase.google.com/) にアクセス
- [ ] Googleアカウントでログイン
- [ ] 「プロジェクトを作成」をクリック
- [ ] プロジェクト名: `lifelog-backend`（任意）
- [ ] Googleアナリティクスは「無効」でOK
- [ ] 作成完了まで待つ（1-2分）

#### 1.2 Firestoreデータベース有効化
- [ ] Firebaseコンソールで「Firestore Database」をクリック
- [ ] 「データベースを作成」をクリック
- [ ] 「本番モードで開始」を選択
- [ ] ロケーション: `asia-northeast1`（東京）を選択
- [ ] 「有効にする」をクリック

#### 1.3 Firebase Authentication有効化
- [ ] 「Authentication」をクリック
- [ ] 「始める」をクリック
- [ ] 「メール/パスワード」を選択して有効化
- [ ] 「メールリンク（パスワードなしでログイン）」は無効のままでOK

#### 1.4 iOSアプリをFirebaseに登録
- [ ] 「プロジェクトの概要」→「iOSアプリを追加」
- [ ] バンドルID: `com.yourname.lifelog`（Xcodeで確認）
- [ ] 「アプリを登録」をクリック
- [ ] `GoogleService-Info.plist` をダウンロード
- [ ] ダウンロードしたファイルをXcodeプロジェクトに追加

#### 1.5 Resendアカウント作成
- [ ] [Resend](https://resend.com/) にアクセス
- [ ] アカウント作成（GitHubログインが簡単）
- [ ] APIキーを作成してメモしておく
- [ ] 送信元ドメインを設定（必要に応じて）

---

### Phase 2: iOS側の実装（コード作業）

#### 2.1 Firebase SDKの導入
- [ ] Xcodeプロジェクトに Firebase SDK を追加
- [ ] 必要なパッケージ: FirebaseAuth, FirebaseFirestore, FirebaseStorage
- [ ] `GoogleService-Info.plist` が追加されていることを確認

#### 2.2 認証機能の実装
- [ ] `AuthService.swift` を作成
- [ ] メールアドレス + パスワードでのログイン機能
- [ ] メール認証（verification）機能
- [ ] ログイン状態の管理

#### 2.3 データモデルの作成
- [ ] `ImportantLetter.swift` を作成
- [ ] `Recipient.swift` を作成
- [ ] Firestoreとの変換ロジック

#### 2.4 手紙作成UIの実装
- [ ] `ImportantLetterEditorView.swift` を作成
- [ ] 宛先入力（最大5名）
- [ ] 本文入力
- [ ] 写真選択（最大5枚）
- [ ] 送信条件の設定
- [ ] 事前通知オプション

#### 2.5 手紙一覧UIの実装
- [ ] `ImportantLetterListView.swift` を作成
- [ ] 作成済みの手紙一覧表示
- [ ] 編集・削除機能
- [ ] ステータス表示（アクティブ/確認中/送信済み）

#### 2.6 設定画面への組み込み
- [ ] 「ひみつの機能」セクションに追加
- [ ] メール未認証時の案内表示

---

### Phase 3: バックエンドの実装（Cloud Functions）

#### 3.1 開発環境のセットアップ
- [ ] Node.js をインストール（なければ）
- [ ] Firebase CLI をインストール: `npm install -g firebase-tools`
- [ ] ログイン: `firebase login`
- [ ] プロジェクト初期化: `firebase init functions`

#### 3.2 定期実行処理の実装
- [ ] 毎日1回実行される関数を作成
- [ ] 全ユーザーの `lastActiveAt` をチェック
- [ ] 条件を満たすユーザーを抽出
- [ ] 確認メール送信処理

#### 3.3 メール送信処理の実装
- [ ] Resend APIの呼び出し
- [ ] 確認メールのテンプレート
- [ ] 本メールのテンプレート
- [ ] キャンセルリンクの生成

#### 3.4 Webhook処理の実装
- [ ] キャンセルリンククリック時の処理
- [ ] 通報・ブロック処理

#### 3.5 デプロイ
- [ ] `firebase deploy --only functions`

---

### Phase 4: テストと確認

#### 4.1 ローカルテスト
- [ ] 手紙を作成して保存できるか
- [ ] 手紙がFirestoreに保存されているか（Firebase Consoleで確認）
- [ ] 写真がStorageにアップロードされているか

#### 4.2 メール送信テスト
- [ ] Cloud Functionsをデプロイ
- [ ] テスト用のユーザーで手紙を作成
- [ ] 非アクティブ期間を短く（1分など）設定してテスト
- [ ] 確認メールが届くか
- [ ] キャンセルリンクが動作するか
- [ ] 本メールが届くか

#### 4.3 セキュリティテスト
- [ ] 未認証ユーザーがアクセスできないか
- [ ] 他人の手紙が見えないか
- [ ] レート制限が動作するか

---

## ⏰ 予想作業時間

| Phase | 作業時間 | 難易度 |
|-------|---------|--------|
| Phase 1: 準備 | 2-3時間 | ⭐（簡単） |
| Phase 2: iOS実装 | 8-12時間 | ⭐⭐⭐（中程度） |
| Phase 3: バックエンド | 6-8時間 | ⭐⭐⭐⭐（やや難） |
| Phase 4: テスト | 2-3時間 | ⭐⭐（簡単） |
| **合計** | **18-26時間** | |

---

## 💡 実装のコツ

1. **Phase 1を完璧に終わらせてから次へ** - 設定ミスがあると後で苦労する
2. **こまめにテスト** - 大きな機能を一気に作らず、小さく作ってテスト
3. **Firebase Console をよく見る** - データがちゃんと保存されているか確認
4. **わからなかったら聞く** - 一人で悩まず相談

